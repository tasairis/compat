<!doctype html>
<html>
	<head>
		<title>[EDGE] tasairis's SE Compatibility Tracking - Detailed View</title>
		<style>
			body[data-loading] .not-loading, body:not([data-loading]) .loading { display: none; }
			table { border-collapse: collapse; }
			table thead { background: #000; color: #fff; position: sticky; top: 0; }
			table thead th { white-space: nowrap; }
			table thead th[data-sortable] { cursor: ns-resize; }
			table tbody tr:nth-child(2n) { background: #eee; }
			table tbody tr + tr { border-top: 1px solid #ccc; }
			table tr.sort-hidden { display: none; }
		</style>
	</head>

	<body data-nsfw="nsfw" data-deleted="hide" data-req="" data-loading>
		<h1>Loading data sources...</h1>
		<table id="table" class="not-loading">
			<thead>
				<tr>
					<th>ID</th>
					<th>SE Status</th>
					<th>LL Category</th>
					<th>Mod</th>
					<th>URL</th>
					<th>SE/LE<br>Compatible?</th>
					<th data-sortable data-sortinv>Last Seen</th>
					<th data-sortable data-sortinv>Last Updated</th>
				</tr>
			</thead>
		</table>
	</body>

	<script>
		function apply_sortable() {
			const headers = [...document.querySelectorAll("#table thead th")];

			const sortingstate = new Map();
			let sortingby = undefined;
			headers.forEach((th, i) => {
				if (!th.dataset.hasOwnProperty("sortable")) {
					return;
				}

				const icon = document.createElement("SPAN");
				icon.innerText = "";
				th.innerText = "🔃 " + th.innerText;
				th.appendChild(icon);

				sortingstate.set(th, 0);

				const dir = th.dataset.hasOwnProperty("sortinv") ? -1 : 1;
				th.addEventListener("click", with_status(`Applying sort...`, () => {
					if (sortingby && sortingby != th) {
						sortingstate.set(sortingby, 0);
						sortingby.querySelector("span").innerText = "";
					}
					sortingby = th;

					let cmp = null;

					const state = (3 + sortingstate.get(th) + dir) % 3;
					console.log(`sort state ${state}`);
					if (state == 1) {
						icon.innerText = " ⬆️";
						cmp = ([a], [b]) => a.localeCompare(b);
					} else if (state == 2) {
						icon.innerText = " ⬇️";
						cmp = ([a], [b]) => b.localeCompare(a);
					} else {
						icon.innerText = "";
						cmp = ([a], [b]) => a - b;
					}
					sortingstate.set(th, state);

					const rows = [];
					for (const row of document.querySelectorAll("#table tbody tr")) {
						const comparable = state == 0
							? Number(row.dataset.index)
							: row.querySelectorAll("td").item(i).dataset.sort;
						if (comparable) {
							row.classList.remove("sort-hidden");
							rows.push([comparable, row]);
						} else {
							row.classList.add("sort-hidden");
						}
					}

					const tbody = document.querySelector("#table tbody");
					rows.sort(cmp).forEach(([, tr]) => tbody.appendChild(tr));
				}));
			});
		}

		function with_status(status, cb) {
			return (...args) => {
				const h1 = document.querySelector("h1");
				const oldhtml = h1.innerHTML;
				h1.innerText = status;

				setTimeout(() => {
					cb(...args);
					h1.innerHTML = oldhtml;
				}, 100);
			};
		}

		function compat_progress(mods, mtotal, sources, stotal) {
			console.debug(`⬇️ Received source ${sources} of ${stotal}...`);
			document.querySelector("h1").innerText = `Loaded data source ${sources} of ${stotal}...`;
		}

		function compat_loaded1(info) {
			const { date, skyrim, data, sources } = info;

			console.info(`✅ All data received: ${data.length} mods; last updated ${date}; supports Skyrim SE ${skyrim}`);

			document.querySelector("h1").innerText = `Processing ${data.length} mods...`;
			setTimeout(() => compat_loaded2(info), 10);
		}

		function compat_loaded2(info) {
			const { data } = info;
			data.sort((a, b) => a.name_sort.localeCompare(b.name_sort));

			console.debug("⚙️ Beginning processing of mods...");

			const timer = Date.now();

			const td = (text, cb) => {
				const td = document.createElement("TD");
				td.innerText = text;
				cb && cb(td);
				return td;
			};

			const tbody = document.createElement("TBODY");

			let i = 0;
			for (const { id, slug, name, status, ll_url, ll_category, compat_se, compat_le, ll_lastseen, ll_lastupdated } of data) {
				const tr = document.createElement("TR");
				tr.id = slug;
				tr.dataset.index = i;

				tr.appendChild(td(id));
				tr.appendChild(td(status));
				tr.appendChild(td(ll_category));
				tr.appendChild(td(name));
				tr.appendChild(td(ll_url || ""));
				tr.appendChild(td(`${compat_se} / ${compat_le}`));
				tr.appendChild(ll_lastseen
					? td(new Date(ll_lastseen).toLocaleDateString(), td => {
						td.dataset.sort = ll_lastseen;
					})
					: td("")
				);
				tr.appendChild(ll_lastupdated
					? td(new Date(ll_lastupdated).toLocaleDateString(), td => {
						td.dataset.sort = ll_lastupdated;
					})
					: td("")
				);

				tbody.appendChild(tr);

				if ((++i % 1000) == 0) {
					console.debug(`⌛ ...${i}...`);
				}
			}

			console.info(`✅ Processing complete (${Date.now() - timer} ms)`);

			document.querySelector("h1").innerText = "Rendering...";
			setTimeout(() => compat_loaded3(tbody, info), 10);
		}

		function compat_loaded3(tbody, info) {
			document.querySelector("#table").appendChild(tbody);
			delete document.body.dataset.loading;

			document.querySelector("h1").innerText = `${info.date} - Skyrim SE/AE ${info.skyrim} - ${info.data.length} mods`;

			apply_sortable();
		}
	</script>
	<script src="https://tasairis.github.io/compat-data/entry.js" crossorigin="anonymous" async data-jsonp="compat_loaded1" data-progressp="compat_progress"></script>
</html>
